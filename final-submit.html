<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>MODASOU | Final Submission</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!-- Modern EmailJS SDK (v4) -->

</head>
<!-- ================= STYLE ================= -->
<style>
* {
  box-sizing: border-box;
  font-family: "Segoe UI", sans-serif;
}

body {
  margin: 0;
  background: #fdf6ee;
}

/* ===== NAVBAR ===== */
.navbar {
  height: 100px;
  background: linear-gradient(135deg, #331300, #8b4513);
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 24px;
}

.logo-circle {
  width: 90px;
  height: 90px;
  border-radius: 50%;
  background-image: url("ModasouLogo.png");
  background-size: cover;

  color: #331300;
  font-weight: 900;
  font-size: 11px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.home-btn {
  color: #fff;
  text-decoration: none;
  border: 1.5px solid #d4af37;
  padding: 8px 18px;
  border-radius: 20px;
  font-weight: 600;
}

.home-btn:hover {
  background: #d4af37;
  color: #331300;
}

/* ===== FORM ===== */
.form-card {
  max-width: 480px;
  margin: 40px auto;
  background: #fffaf3;
  padding: 30px;
  border-radius: 18px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.12);
}

.form-card h2 {
  text-align: center;
  color: #331300;
  margin-bottom: 25px;
}

.field {
  margin-bottom: 18px;
}

.field label {
  display: block;
  margin-bottom: 6px;
  font-weight: 600;
  color: #331300;
}

.field input,
.field textarea {
  width: 100%;
  padding: 10px 12px;
  border-radius: 8px;
  border: 1.8px solid #8b4513;
  font-size: 14px;
}

.field input:focus,
.field textarea:focus {
  outline: none;
  border-color: #d4af37;
}

/* ===== SUBMIT BUTTON ===== */
.submit-btn {
  width: 100%;
  padding: 12px;
  background: linear-gradient(135deg, #8b4513, #331300);
  color: #fff;
  border: none;
  border-radius: 12px;
  font-size: 15px;
  font-weight: 700;
  cursor: pointer;
}

.submit-btn:active {
  transform: scale(0.97);
}

/* ===== SUCCESS POPUP ===== */
.popup {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  display: none;
  align-items: center;
  justify-content: center;
}

.popup-box {
  background: #fff;
  padding: 30px;
  border-radius: 14px;
  text-align: center;
  width: 90%;
  max-width: 360px;
}

.popup-box h3 {
  color: #331300;
}

.popup-box button {
  margin-top: 15px;
  padding: 10px 18px;
  background: #8b4513;
  color: #fff;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}

/* ===== FOOTER ===== */
.footer {
  background: #331300;
  color: #f3d9a5;
  text-align: center;
  padding: 16px;
  font-size: 13px;
}
</style>
</head>

<body>

<!-- ===== NAVBAR ===== -->
<nav class="navbar">
  <div class="logo-circle"></div>
  
  <a href="index.html" class="home-btn">Home</a>
</nav>

<!-- ===== FORM ===== -->
<div class="form-card">
  <h2>Final Details</h2>

  <form id="finalForm">

    <div class="field">
      <label>Full Name</label>
      <input type="text" id="name" name="name" required
        pattern="[A-Za-z\s]+"
        title="Only letters allowed">
    </div>

    <div class="field">
      <label>WhatsApp Number</label>
      <input type="tel" id="whatsapp" name="watsapp" required
        pattern="[0-9]{10}" maxlength="10">
    </div>

    <div class="field">
      <label>Email Address</label>
      <input type="email" id="email" name="email" required>
    </div>
       
     <div class="field">
        <label>Pickup Date</label>
        <input type="date" id="pickup_date" name="pickup_date" required min="2024-01-01">
      </div>

      <div class="field">
        <label>Pickup Time Slot</label>
        <select id="pickup_time" name="pickup_time" required>
          <option value="">Select Time Slot</option>
          <option value="9:00 AM - 1:00 PM">9:00 AM ‚Äì 1:00 PM</option>
          <option value="1:00 PM - 6:00 PM">1:00 PM ‚Äì 6:00 PM</option>
          <option value="6:00 PM - 10:00 PM">6:00 PM ‚Äì 10:00 PM</option>
        </select>
      </div>

    <div class="field">
      <label>Residential Address</label>
      <textarea id="address" rows="3" name="address" required></textarea>
    </div>

    <div class="field">
      <label>Pincode</label>
      <input type="text" id="pincode" name="pincode"
        pattern="[0-9]{6}" maxlength="6" required>
    </div>

    <!-- IMPORTANT: button type=button (NO page reset) -->
    <button type="button" class="submit-btn" id="submitBtn">
      Submit Order
    </button>

  </form>
</div>

<!-- ===== SUCCESS POPUP ===== -->
<div class="popup" id="successPopup">
  <div class="popup-box">
    <h3>Submitted Successfully üéâ</h3>
    <p>Your order details are saved.</p>
    <button onclick="goNext()">Next</button>
  </div>
</div>

<!-- ===== FOOTER ===== -->
<footer class="footer">
  ¬© 2025 MODASOU ‚Ä¢ Premium Custom Tailoring
</footer>

<script>
  // ========================================
// FINAL SUBMIT - CORRECTED FOR UUID DATABASE
// ========================================

const SUPABASE_URL = 'https://gztneesmxwfhdmhqikel.supabase.co'; 
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd6dG5lZXNteHdmaGRtaHFpa2VsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxNjAzNDAsImV4cCI6MjA4MjczNjM0MH0.iWDtkljuQLZFQeLvBrJHVyXNfpu4bJOvvVab3G0eOsA';

const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
// Helper function to get form values safely
function getValue(elementId) {
  const element = document.getElementById(elementId);
  return element ? element.value : '';
}
document.getElementById("submitBtn").addEventListener("click", async () => {
  const btn = document.getElementById("submitBtn");

  // Get form values
  const name = document.getElementById("name").value.trim();
  const whatsapp = document.getElementById("whatsapp").value.trim();
  const email = document.getElementById("email").value.trim();
  const address = document.getElementById("address").value.trim();
  const pincode = document.getElementById("pincode").value.trim();

  // Validate
  if (!name || !whatsapp || !email || !address || !pincode) {
    alert("‚ö†Ô∏è Please fill in all details before submitting.");
    return;
  }

  // Get session ID
  const sessionId = localStorage.getItem("modasou_session_id");
  
  if (!sessionId) {
    alert("‚ö†Ô∏è Session not found. Please complete the measurement step first.");
    return;
  }

  btn.innerText = "Processing...";
  btn.disabled = true;

  try {
    // Get all data from localStorage
    const fabricVideoLink = localStorage.getItem("fabricVideoLink") || "";
    const fabricImageLink = localStorage.getItem("fabricImageLink") || "";
    const fabricNotes = localStorage.getItem("fabricNotes") || "";
    const fabricTopQty = localStorage.getItem("fabricTopQty") || "";
    const fabricBottomQty = localStorage.getItem("fabricBottomQty") || "";
    const fabricLining = localStorage.getItem("fabricLining") || "";
    const serviceType = localStorage.getItem("selectedService") || "Custom Order";

    // --- CHANGE 1: REMOVED MANUAL ID GENERATION ---
    // The Database will provide the ID now.
    console.log("Updating order for session:", sessionId);

    // ========================================
    // UPDATE THE EXISTING ORDER
    // ========================================
    const { data, error } = await _supabase
      .from('orders')
      .update({
        // Do NOT send order_id here. The DB has already created it or will handle it.
        name: name,
        whatsapp: whatsapp,
        email: email,
                  pickup_date: getValue('pickup_date') || "Not Specified",
          pickup_time: getValue('pickup_time') || "Not Specified",
          
        address: address,
        pincode: pincode,
        video_url: fabricVideoLink,
        image_url: fabricImageLink,
        note: fabricNotes,
        top_meter: fabricTopQty.split(' ')[0] || null,
        bottom_meter: fabricBottomQty.split(' ')[0] || null,
        lining_preference: fabricLining,
        status: 'submitted'
      })
      .eq('session_id', sessionId)
      .select(); // --- CHANGE 2: ADDED .select() TO GET THE ID BACK ---

    if (error) {
      console.error("Database Error:", error);
      throw new Error(error.message);
    }

    // Retrieve the Auto-Generated UUID from the database response
    // Use optional chaining just in case data is empty
    const savedOrder = data && data.length > 0 ? data[0] : null;
    const finalOrderId = savedOrder ? savedOrder.order_id : "UNKNOWN_ID";
    const orderCode = "MODASOU_" + String(Date.now()).slice(-4);

    console.log("‚úÖ Order updated successfully! ID:", finalOrderId);

    // ========================================
    // SEND EMAIL NOTIFICATION
    // ========================================
    btn.innerText = "Sending confirmation...";
    
    try {
      const userFlow = localStorage.getItem("active_service");
      let measurementsRaw = userFlow === "service2" 
        ? localStorage.getItem("service2_data") || "{}" 
        : localStorage.getItem("measurements") || "{}";
      
      const measurementsObj = JSON.parse(measurementsRaw);
      
      // Format measurements
      let measurementText = "";
      for (const [key, value] of Object.entries(measurementsObj)) {
        if(value) {
          measurementText += `${key.replace(/_/g, ' ').toUpperCase()}: ${value}\n`;
        }
      }

      // Send email
      const { data: emailData, error: emailError } = await _supabase.functions.invoke(
        'send_final_order_email',
        {
          body: {
            order_id: finalOrderId, // Send the real UUID
            order_code: orderCode,
            customer_name: name,
            whatsapp: whatsapp,
            email: email,
            pickup_date: getValue('pickup_date') || "Not Specified",
            pickup_time: getValue('pickup_time') || "Not Specified",
            address: address,
            pincode: pincode,
            service_type: serviceType,
            measurement_category: serviceType,
            fabric_top_qty: fabricTopQty,
            fabric_bottom_qty: fabricBottomQty,
            fabric_lining: fabricLining,
            fabric_notes: fabricNotes,
            video_link: fabricVideoLink || "Not provided",
            reference_image_link: fabricImageLink || "Not provided",
            measurements_list: measurementText || "No measurements provided",
            order_date: new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' })
          },
        }
      );

      if (emailError) {
        console.warn("Email notification failed (invoke):", emailError);
        try {
          const fnUrl = `${SUPABASE_URL}/functions/v1/send_final_order_email`;
          const resp = await fetch(fnUrl, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
              'apikey': SUPABASE_ANON_KEY,
              'Content-Type': 'application/json',
              'x-client-info': 'modasou-final-submit'
            },
            body: JSON.stringify({
              order_id: finalOrderId,
              order_code: orderCode,
              customer_name: name,
              whatsapp: whatsapp,
              email: email,
              address: address,
              pincode: pincode,
              service_type: serviceType,
              measurement_category: serviceType,
              fabric_top_qty: fabricTopQty,
              fabric_bottom_qty: fabricBottomQty,
              fabric_lining: fabricLining,
              fabric_notes: fabricNotes,
              video_link: fabricVideoLink || "Not provided",
              reference_image_link: fabricImageLink || "Not provided",
              measurements_list: measurementText || "No measurements provided",
              order_date: new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' })
            })
          });
          const raw = await resp.text();
          if (!resp.ok) {
            alert(`‚ö†Ô∏è Order saved, but email failed.\n\nStatus: ${resp.status}\nDetails: ${raw}`);
          }
        } catch (fallbackErr) {
          alert(`‚ö†Ô∏è Order saved, but email failed.\n\nReason: ${fallbackErr.message}`);
        }
      } else {
        console.log("Email sent successfully:", emailData);
      }

    } catch (emailErr) {
      console.warn("Email notification failed (order still saved):", emailErr);
    }

    // ========================================
    // SUCCESS!
    // ========================================
    alert(`‚úÖ Order Submitted Successfully!\n\nOrder ID: ${orderCode}\n\nWe'll contact you soon on WhatsApp!`);
    
    // Clear localStorage
    localStorage.removeItem('measurements');
    localStorage.removeItem('service2_data');
    localStorage.removeItem('fabricVideoLink');
    localStorage.removeItem('fabricImageLink');
    localStorage.removeItem('fabricNotes');
    localStorage.removeItem('fabricTopQty');
    localStorage.removeItem('fabricBottomQty');
    localStorage.removeItem('fabricLining');
    localStorage.removeItem('selectedService');
    
    // Redirect
    setTimeout(() => {
      window.location.href = "/thank-you.html";
    }, 1500);

  } catch (err) {
    console.error("Submission Error:", err);
    alert(`‚ùå Failed to submit order.\n\nError: ${err.message}\n\nPlease try again or contact support.`);
    
    btn.innerText = "Submit Order";
    btn.disabled = false;
  }
});

function goNext() {
  window.location.href = "index.html";
}
</script></body></html>
