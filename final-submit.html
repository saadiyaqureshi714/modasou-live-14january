<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>MODASOU | Final Submission</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!-- Modern EmailJS SDK (v4) -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
</head>
<!-- ================= STYLE ================= -->
<style>
* {
  box-sizing: border-box;
  font-family: "Segoe UI", sans-serif;
}

body {
  margin: 0;
  background: #fdf6ee;
}

/* ===== NAVBAR ===== */
.navbar {
  height: 100px;
  background: linear-gradient(135deg, #331300, #8b4513);
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 24px;
}

.logo-circle {
  width: 90px;
  height: 90px;
  border-radius: 50%;
  background-image: url("ModasouLogo.png");
  background-size: cover;

  color: #331300;
  font-weight: 900;
  font-size: 11px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.home-btn {
  color: #fff;
  text-decoration: none;
  border: 1.5px solid #d4af37;
  padding: 8px 18px;
  border-radius: 20px;
  font-weight: 600;
}

.home-btn:hover {
  background: #d4af37;
  color: #331300;
}

/* ===== FORM ===== */
.form-card {
  max-width: 480px;
  margin: 40px auto;
  background: #fffaf3;
  padding: 30px;
  border-radius: 18px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.12);
}

.form-card h2 {
  text-align: center;
  color: #331300;
  margin-bottom: 25px;
}

.field {
  margin-bottom: 18px;
}

.field label {
  display: block;
  margin-bottom: 6px;
  font-weight: 600;
  color: #331300;
}

.field input,
.field textarea {
  width: 100%;
  padding: 10px 12px;
  border-radius: 8px;
  border: 1.8px solid #8b4513;
  font-size: 14px;
}

.field input:focus,
.field textarea:focus {
  outline: none;
  border-color: #d4af37;
}

/* ===== SUBMIT BUTTON ===== */
.submit-btn {
  width: 100%;
  padding: 12px;
  background: linear-gradient(135deg, #8b4513, #331300);
  color: #fff;
  border: none;
  border-radius: 12px;
  font-size: 15px;
  font-weight: 700;
  cursor: pointer;
}

.submit-btn:active {
  transform: scale(0.97);
}

/* ===== SUCCESS POPUP ===== */
.popup {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  display: none;
  align-items: center;
  justify-content: center;
}

.popup-box {
  background: #fff;
  padding: 30px;
  border-radius: 14px;
  text-align: center;
  width: 90%;
  max-width: 360px;
}

.popup-box h3 {
  color: #331300;
}

.popup-box button {
  margin-top: 15px;
  padding: 10px 18px;
  background: #8b4513;
  color: #fff;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}

/* ===== FOOTER ===== */
.footer {
  background: #331300;
  color: #f3d9a5;
  text-align: center;
  padding: 16px;
  font-size: 13px;
}
</style>
</head>

<body>

<!-- ===== NAVBAR ===== -->
<nav class="navbar">
  <div class="logo-circle"></div>
  
  <a href="index.html" class="home-btn">Home</a>
</nav>

<!-- ===== FORM ===== -->
<div class="form-card">
  <h2>Final Details</h2>

  <form id="finalForm">

    <div class="field">
      <label>Full Name</label>
      <input type="text" id="name" name="name" required
        pattern="[A-Za-z\s]+"
        title="Only letters allowed">
    </div>

    <div class="field">
      <label>WhatsApp Number</label>
      <input type="tel" id="whatsapp" name="watsapp" required
        pattern="[0-9]{10}" maxlength="10">
    </div>

    <div class="field">
      <label>Email Address</label>
      <input type="email" id="email" name="email" required>
    </div>

    <div class="field">
      <label>Residential Address</label>
      <textarea id="address" rows="3" name="address" required></textarea>
    </div>

    <div class="field">
      <label>Pincode</label>
      <input type="text" id="pincode" name="pincode"
        pattern="[0-9]{6}" maxlength="6" required>
    </div>

    <!-- IMPORTANT: button type=button (NO page reset) -->
    <button type="button" class="submit-btn" id="submitBtn">
      Submit Order
    </button>

  </form>
</div>

<!-- ===== SUCCESS POPUP ===== -->
<div class="popup" id="successPopup">
  <div class="popup-box">
    <h3>Submitted Successfully üéâ</h3>
    <p>Your order details are saved.</p>
    <button onclick="goNext()">Next</button>
  </div>
</div>

<!-- ===== FOOTER ===== -->
<footer class="footer">
  ¬© 2025 MODASOU ‚Ä¢ Premium Custom Tailoring
</footer>



<script>
  // CONFIGURATION
  const SUPABASE_URL = 'https://gztneesmxwfhdmhqikel.supabase.co'; 
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd6dG5lZXNteHdmaGRtaHFpa2VsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxNjAzNDAsImV4cCI6MjA4MjczNjM0MH0.iWDtkljuQLZFQeLvBrJHVyXNfpu4bJOvvVab3G0eOsA';
  
  const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  
  emailjs.init({
    publicKey: "V5fGF5JF2JAOD_AcW", 
  });

  document.getElementById("submitBtn").addEventListener("click", async () => {
    const btn = document.getElementById("submitBtn");

    // 1. Contact Info
    const name = document.getElementById("name").value.trim();
    const whatsapp = document.getElementById("whatsapp").value.trim();
    const email = document.getElementById("email").value.trim();
    const address = document.getElementById("address").value.trim();
    const pincode = document.getElementById("pincode").value.trim();

    if (!name || !whatsapp || !email || !address || !pincode) {
      alert("Please fill in all details before submitting.");
      return;
    }

    // 2. RETRIEVE ALL SAVED DATA & IDENTIFY SERVICE
    const service = localStorage.getItem("selectedService") || "General Order";
    const fabricNotes = localStorage.getItem("fabricNotes") || "None";
    const userFlow = localStorage.getItem("active_service"); // "service1" or "service2"

    // --- PART 1: GET MEASUREMENTS ---
    let measurementsRaw = "{}";

    if (userFlow === "service2") {
        measurementsRaw = localStorage.getItem("service2_data") || "{}";
    } else {
        // Service 1 (Dress, Pants, etc)
        measurementsRaw = localStorage.getItem("measurements") || "{}";
    }
    
    const measurementsObj = JSON.parse(measurementsRaw);

    // --- PART 2: HANDLE LINKS (CORRECTED LOGIC) ---
    
    // A. VIDEO LINK (Standard)
    const rawVideo = localStorage.getItem("fabricVideoLink");
    const finalVideoLink = rawVideo 
      ? `<a href="${rawVideo}" target="_blank" style="color: blue; text-decoration: underline;">See Fabric Video</a>`
      : "Not Provided";

    // B. DESIGN IMAGE (Visible for EVERYONE - Service 1 & 2)
    const rawDesignImage = localStorage.getItem("fabricImageLink");
    const finalDesignLink = rawDesignImage 
      ? `<a href="${rawDesignImage}" target="_blank" style="color: blue; text-decoration: underline;">See Design Image</a>`
      : "Not Provided";

    // C. GOOGLE IMAGE (NEW! - Visible ONLY for Service 2)
    // Ensure your Service 2 page saves this as "googleImageLink"
    const rawGoogleImage = localStorage.getItem("googleImageLink"); 
    let finalGoogleLink = "Not Available"; // Default for Service 1

    if (userFlow === "service2" && rawGoogleImage) {
        finalGoogleLink = `<a href="${rawGoogleImage}" target="_blank" style="color: blue; text-decoration: underline;">See Google Image</a>`;
    }

    // Retrieve Fabric Dimensions
    const fabTop = localStorage.getItem("fabricTopQty") || "Not provided";
    const fabBot = localStorage.getItem("fabricBottomQty") || "Not provided";
    const fabLining = localStorage.getItem("fabricLining") || "Not specified";

    // 3. Format Measurements
    let measurementSummary = "";
    let hasMeasurements = false;
    
    for (const [key, value] of Object.entries(measurementsObj)) {
      if(value) {
        const cleanKey = key.replace(/_/g, ' ').toUpperCase(); 
        measurementSummary += `${cleanKey}: ${value}\n`;
        hasMeasurements = true;
      }
    }
    
    if(!hasMeasurements) measurementSummary = "‚ö†Ô∏è No measurements were entered on the previous page.";

    btn.innerText = "Processing...";
    btn.disabled = true;

    try {
      // 4. Send Email with ALL Details
      const uniqueOrderId = "MODASOU_" + Math.floor(1000 + Math.random() * 9000);
      
      await emailjs.send(
        "TailorEmailService", 
        "template_jpeqr8e", 
        { 
          order_id: uniqueOrderId,
          
          fabric_top_qty: fabTop,
          fabric_bottom_qty: fabBot,
          fabric_lining: fabLining,
          fabric_notes: fabricNotes,
          
          // --- UPDATED LINKS ---
          video_link: finalVideoLink, 
          reference_image_link: finalDesignLink, // This works for Service 1 now!
          google_image_url: finalGoogleLink,    // This sends "Not Available" for Service 1
          
          measurements_list: measurementSummary,
          customer_name: name,
          whatsapp: whatsapp,
          email: email,
          address: address,
          pincode: pincode,
          service_type: service, 
          
          order_date: new Date().toLocaleString()
        }
      );

      // Success
      document.getElementById("successPopup").style.display = "flex";
      localStorage.clear(); 

    } catch (err) {
      console.error("Email Error:", err);
      alert("Email failed: " + (err.text || err.message));
      btn.innerText = "Submit Order";
      btn.disabled = false;
    }
  });

  function goNext() {
    window.location.href = "index.html";
  }
</script></body></html>