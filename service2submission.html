<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>MODASOU | Final Submission</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!-- Modern EmailJS SDK (v4) -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
</head>
<!-- ================= STYLE ================= -->
<style>
* {
  box-sizing: border-box;
  font-family: "Segoe UI", sans-serif;
}

body {
  margin: 0;
  background: #8b4513;
}

/* ===== NAVBAR ===== */
.navbar {
  height: 100px;
  background: linear-gradient(135deg, #331300, #8b4513);
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 24px;
}

.logo-circle {
  width: 90px;
  height: 90px;
  border-radius: 50%;
  background-image: url("ModasouLogo.png");
  background-size: cover;

  color: #331300;
  font-weight: 900;
  font-size: 11px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.home-btn {
  color: #fff;
  text-decoration: none;
  border: 1.5px solid #d4af37;
  padding: 8px 18px;
  border-radius: 20px;
  font-weight: 600;
}

.home-btn:hover {
  background: #d4af37;
  color: #331300;
}

/* ===== FORM ===== */
.form-card {
  max-width: 480px;
  margin: 40px auto;
  background: #fffaf3;
  padding: 30px;
  border-radius: 18px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.12);
}

.form-card h2 {
  text-align: center;
  color: #331300;
  margin-bottom: 25px;
}

.field {
  margin-bottom: 18px;
}

.field label {
  display: block;
  margin-bottom: 6px;
  font-weight: 600;
  color: #331300;
}

.field input,
.field textarea {
  width: 100%;
  padding: 10px 12px;
  border-radius: 8px;
  border: 1.8px solid #8b4513;
  font-size: 14px;
}

.field input:focus,
.field textarea:focus {
  outline: none;
  border-color: #d4af37;
}

/* ===== SUBMIT BUTTON ===== */
.submit-btn {
  width: 100%;
  padding: 12px;
  background: linear-gradient(135deg, #8b4513, #331300);
  color: #fff;
  border: none;
  border-radius: 12px;
  font-size: 15px;
  font-weight: 700;
  cursor: pointer;
}

.submit-btn:active {
  transform: scale(0.97);
}

/* ===== SUCCESS POPUP ===== */
.popup {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  display: none;
  align-items: center;
  justify-content: center;
}

.popup-box {
  background: #fff;
  padding: 30px;
  border-radius: 14px;
  text-align: center;
  width: 90%;
  max-width: 360px;
}

.popup-box h3 {
  color: #331300;
}

.popup-box button {
  margin-top: 15px;
  padding: 10px 18px;
  background: #8b4513;
  color: #fff;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}

/* ===== FOOTER ===== */
.footer {
  background: #331300;
  color: #f3d9a5;
  text-align: center;
  padding: 16px;
  font-size: 13px;
}

@media (max-width: 768px) {
  .navbar {
    padding: 0 15px;
  }
  .logo-circle {
    width: 70px;
    height: 70px;
  }
  .form-card {
    margin: 20px;
    padding: 20px;
  }
}
</style>
</head>

<body>

<!-- ===== NAVBAR ===== -->
<nav class="navbar">
  <div class="logo-circle"></div>
  
  <a href="index.html" class="home-btn">Home</a>
</nav>

<!-- ===== FORM ===== -->
<div class="form-card">
  <h2>Final Details</h2>

  <form id="finalForm">

    <div class="field">
      <label>Full Name</label>
      <input type="text" id="name" name="name" required
        pattern="[A-Za-z\s]+"
        title="Only letters allowed">
    </div>

    <div class="field">
      <label>WhatsApp Number</label>
      <input type="tel" id="whatsapp" name="watsapp" required
        pattern="[0-9]{10}" maxlength="10">
    </div>

    <div class="field">
      <label>Email Address</label>
      <input type="email" id="email" name="email" required>
    </div>
   
    
      <div class="field">
        <label>Pickup Date</label>
        <input type="date" id="pickup_date" required min="2026-01-01">
      </div>

      <div class="field">
        <label>Pickup Time Slot</label>
        <select id="pickup_time" required>
          <option value="">Select Time Slot</option>
          <option value="9:00 AM - 1:00 PM">9:00 AM â€“ 1:00 PM</option>
          <option value="1:00 PM - 6:00 PM">1:00 PM â€“ 6:00 PM</option>
          <option value="6:00 PM - 10:00 PM">6:00 PM â€“ 10:00 PM</option>
        </select>
      </div>

    <div class="field">
      <label>Residential Address</label>
      <textarea id="address" rows="3" name="address" required></textarea>
    </div>

    <div class="field">
      <label>Pincode</label>
      <input type="text" id="pincode" name="pincode"
        pattern="[0-9]{6}" maxlength="6" required>
    </div>

    <!-- IMPORTANT: button type=button (NO page reset) -->
    <button type="button" class="submit-btn" id="submitBtn">
      Submit Order
    </button>

  </form>
</div>

<!-- ===== SUCCESS POPUP ===== -->
<div class="popup" id="successPopup">
  <div class="popup-box">
    <h3>Submitted Successfully ðŸŽ‰</h3>
    <p>Your order details are saved.</p>
    <button onclick="goNext()">Next</button>
  </div>
</div>

<!-- ===== FOOTER ===== -->
<footer class="footer">
  Â© 2025 MODASOU â€¢ Premium Custom Tailoring
</footer>





<script>
  // 1. Initialize EmailJS and Supabase
  emailjs.init("V5fGF5JF2JAOD_AcW"); 
  const m_db = window.supabase.createClient(
    'https://gztneesmxwfhdmhqikel.supabase.co', 
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd6dG5lZXNteHdmaGRtaHFpa2VsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxNjAzNDAsImV4cCI6MjA4MjczNjM0MH0.iWDtkljuQLZFQeLvBrJHVyXNfpu4bJOvvVab3G0eOsA'
  );

  async function handleFinalOrder(e) {
    e.preventDefault(); 
    
    const btn = document.getElementById('submitBtn');
    if (!btn) { console.error("Button not found"); return; }

    const sessionId = localStorage.getItem('modasou_session_id');

    if (!sessionId) {
      alert("Error: No session found. Please start over.");
      return;
    }

    btn.innerText = "Processing Order...";
    btn.disabled = true;

    try {
      // --- STEP 1: FETCH SUPABASE DATA ---
      const { data: allRows, error: fetchError } = await m_db
        .from('service_2')
        .select('*')
        .eq('session_id', sessionId);

      if (fetchError) throw new Error("Database Fetch Error: " + fetchError.message);
      if (!allRows || allRows.length === 0) throw new Error("No data found. Did you save Service 2 data?");

      // --- STEP 2: MERGE DATA ---
      let mergedData = {};
      allRows.forEach(row => {
          if (row.top_mtr) mergedData.top_mtr = row.top_mtr;
          if (row.top_cm) mergedData.top_cm = row.top_cm;
          if (row.bottom_mtr) mergedData.bottom_mtr = row.bottom_mtr;
          if (row.bottom_cm) mergedData.bottom_cm = row.bottom_cm;
          if (row.lining_preference) mergedData.lining_preference = row.lining_preference;
          if (row.designer_note) mergedData.designer_note = row.designer_note;
          if (row.fabric_video_url) mergedData.fabric_video_url = row.fabric_video_url;
          if (row.design_image_url) mergedData.design_image_url = row.design_image_url;
          if (row.designer_name) mergedData.designer_name = row.designer_name;
          
          if (row.google_image_url) mergedData.google_image_url = row.google_image_url;
      });

      // --- STEP 3: FETCH MEASUREMENTS & SERVICE NAME (FIXED) ---
      
      // 1. FIX: Check 'selectedService' (Old Script) FIRST, then 'selected_service_type' (New Script)
      const serviceType = localStorage.getItem("selectedService") || localStorage.getItem("selected_service_type") || "Custom Order";

      // 2. Fetch Measurements
      const rawMeasures = localStorage.getItem("measurements") || localStorage.getItem("current_measurement_data") || "{}";
      const measurementsObj = JSON.parse(rawMeasures);
      
      let formattedMeasures = "";
      for (const [key, value] of Object.entries(measurementsObj)) {
         if(value) formattedMeasures += `${key.replace(/_/g, ' ')}: ${value}\n`;
      }

      // --- STEP 4: PREPARE LINKS ---
      const videoHtml = mergedData.fabric_video_url 
        ? `<a href="${mergedData.fabric_video_url}" target="_blank" rel="noopener noreferrer">Watch Video</a>` : "Not Provided";
      const designHtml = mergedData.design_image_url 
        ? `<a href="${mergedData.design_image_url}" target="_blank" rel="noopener noreferrer">View Image</a>` : "Not Provided";

      // --- STEP 5: GOOGLE LINK (Normalized and Encoded) ---
      const ensureUrl = (u) => {
        if (!u) return "";
        let t = String(u).trim();
        // strip quotes
        t = t.replace(/^["']|["']$/g, "");
        
        const original = t;
        // unwrap Google redirect links (q or imgurl param)
        try {
          let tempT = t.match(/^https?:\/\//i) ? t : `https://${t}`;
          const test = new URL(tempT);
          if (test.hostname.includes("google.com")) {
             const sp = new URLSearchParams(test.search);
             const qParam = sp.get("q") || sp.get("imgurl");
             if (qParam) t = decodeURIComponent(qParam);
          }
        } catch {
             t = original;
        }

        if (!/^https?:\/\//i.test(t)) t = `https://${t}`;
        // Sanity check
        if (t === "https://") return "";

        // Final validation: ensure URL is http(s) and has hostname
        try {
          const u2 = new URL(t);
          if (!u2.protocol.startsWith("http")) return "";
          if (!u2.hostname) return "";
          return t;
        } catch {
          return "";
        }
      };
      const googleRaw = ensureUrl(mergedData.google_image_url || "");

      const topQty = mergedData.top_mtr ? `${mergedData.top_mtr}m / ${mergedData.top_cm || 0}cm` : "Not Provided";
      const botQty = mergedData.bottom_mtr ? `${mergedData.bottom_mtr}m / ${mergedData.bottom_cm || 0}cm` : "Not Provided";

      // Generate Order ID
      const uniqueOrderId = "MODASOU_" + Math.floor(1000 + Math.random() * 9000);

      // --- STEP 6: SEND EMAIL ---
      const selectedDesigner = localStorage.getItem("saved_designer_name") || "Not Selected";
// Prepare links for EmailJS
const videoLink = mergedData.fabric_video_url
  ? `<a href="${mergedData.fabric_video_url}" target="_blank" rel="noopener noreferrer" style="color:#1a73e8;text-decoration:none;">Watch Video</a>`
  : "Not Provided";

const designLink = mergedData.design_image_url
  ? `<a href="${mergedData.design_image_url}" target="_blank" rel="noopener noreferrer" style="color:#1a73e8;text-decoration:none;">View Image</a>`
  : "Not Provided";

const googleLink = (googleRaw && googleRaw.length > 10)
  ? `<a href="${googleRaw}" target="_blank" rel="noopener noreferrer" style="color:#1a73e8;text-decoration:none;">View Google Image</a>`
  : "Not Provided";

// Send email
await emailjs.send('TailorEmailService', 'template_jpeqr8e', { 
  order_id: uniqueOrderId,
  
  // Customer Info
  customer_name: document.getElementById('name').value, 
  whatsapp: document.getElementById('whatsapp').value, 
  email: document.getElementById('email').value,
  pickup_date: document.getElementById('pickup_date').value,
   pickup_time: document.getElementById('pickup_time').value,
         
  address: document.getElementById('address').value,
  pincode: document.getElementById('pincode').value,

  // Fabric Details
  fabric_top_qty: topQty,
  fabric_bottom_qty: botQty,
  fabric_lining: mergedData.lining_preference || "N/A",
  fabric_notes: String(mergedData.designer_note || "None").slice(0, 2000),
  
  // Links (already HTML)
  video_link: videoLink,
  reference_image_link: designLink,
  designer_name: mergedData.designer_name || "Not Selected",
  // Only send the template's expected variable to reduce payload
  google_image_url: googleLink,
  
  // Measurements & Service Name
  service_type: serviceType,
  measurements_list: (formattedMeasures || "No measurements found").slice(0, 3000),
  order_date: new Date().toLocaleString()
});


      // Success
      
      localStorage.removeItem('modasou_session_id'); 
      window.location.href="/thank-you.html";

    } catch (err) {
      console.error("Order process failed:", err);
      
      let msg = "Unknown Error";
      if (typeof err === 'string') {
        msg = err;
      } else if (err && err.message) {
        msg = err.message;
      } else if (err && err.text) {
        msg = err.text; // Check for EmailJS text error
      } else {
         try { msg = JSON.stringify(err); } catch {}
      }

      alert("Order Error: " + msg);
      btn.innerText = "Submit Order";
      btn.disabled = false;
    }
  }

  document.getElementById('submitBtn').addEventListener('click', handleFinalOrder);
</script>
</body></html>
