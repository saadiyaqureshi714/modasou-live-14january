<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Modasou - Material Ready, Design Needed</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <!-- Supabase Library -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Poppins", sans-serif; }
    body { background-color: #ffe6a7; color: #331300; }

    /* NAVBAR */
    .navbar {
      width: 100%; display: flex; justify-content: space-around; align-items: center;
      padding: 10px 30px; background: #432818; position: sticky; top: 0; z-index: 1000;
    }
    .logo-container { display: flex; align-items: center; gap: 15px; }
    .logo-img { width: 60px; height: 60px; border: 2px solid #bb9457; border-radius: 50%; }
    .logo-text { font-family: 'Cinzel', serif; font-size: 32px; font-weight: 600; background: linear-gradient(90deg, #ffe6a7, #bb9457, #ffe6a7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .menu-item a { text-decoration: none; color: #f5e6b8; font-size: 18px; }
      
    
    /* HEADER INFO */
    .header-info { text-align: center; margin-top: 20px; padding: 0 20px; }
    .header-info h2 { font-size: 36px; color: #6f1d1b; text-decoration: underline; }
    .header-info h3 { color: #432818; margin: 10px 0; }

    /* CONTAINER */
    .container { max-width: 90%; margin: 30px auto; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 20px; border-radius: 12px; }
    
    .upload-box {  background-color: #fffaf0; border: 2px solid #331300; border-radius: 12px; padding: 20px; text-align: center; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .upload-box h2 { font-size: 20px; color: #6f1d1b; margin-bottom: 15px; text-decoration: underline; }
    
    .form-section { background: #FFF9C4; border: 1px solid #4b2000; border-radius: 10px; padding: 15px; margin: 15px 0; text-align: left; }
    .upload-btn { background: #99582a; color: #fff; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; margin-bottom: 10px; font-weight: bold; width: 100%; }
    
    .video-preview video, .image-preview img, #urlPreview { width: 100%; max-height: 200px; border-radius: 8px; margin-top: 10px; border: 2px solid #bb9457; display: none; background: #000; object-fit: contain;}

    .row { display: flex; align-items: center; margin-bottom: 8px; gap: 10px; }
    .row label { width: 70px; font-size: 14px; font-weight: bold; }
    .row input { flex: 1; padding: 6px; border: 1px solid #99582a; border-radius: 50px; }
    
    .inline-options { display: flex; gap: 10px; margin-top: 10px; }
    .inline-card { flex: 1; border: 1px solid #bb9457; padding: 10px; border-radius: 8px; cursor: pointer; background: white; font-size: 13px; display: flex; align-items: center; gap: 5px; }
    .designer-note textarea { width: 100%; height: 60px; margin-top: 10px; padding: 10px; border-radius: 6px; border: 1px solid #99582a; resize: none; }

    .final-submit { background: #4CAF50; color: white; width: 100%; padding: 15px; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 10px; }
    .final-submit:hover { background: #388E3C; }

    /* GOOGLE SEARCH CARD */
    .google-card { max-width: 80%; margin: 20px auto; background: #dcab6b; padding: 25px; border-radius: 12px; text-align: center; border: 2px solid #432818; }
    .google-card input { width: 80%; padding: 12px; border-radius: 8px; border: 1px solid #99582a; margin: 15px 0; }
    .google-btn { background: #432818; color: #ffe6a7; padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }

    .nav-buttons { display: flex; justify-content: center; gap: 20px; margin-bottom: 40px; }
    .nav-btn { padding: 12px 24px; text-decoration: none; border-radius: 8px; font-weight: bold; background: #4b2000; color: #fff; }
    footer { text-align: center; padding: 20px; background-color: #432818; color: #ffe6a7; }

    </style>
</head>

<body>

<header class="navbar">
  <div class="logo-container">
    <img src="/ModasouLogo.png" class="logo-img" alt="Logo">
    <h1 class="logo-text">MODASOU</h1>
  </div>
  <nav class="menu-item"><a href="/index.html">Home</a></nav>
</header>

<div class="header-info">
  <h2>Design & Stitch</h2>
  <h3>Material is ready, design is needed.</h3>
  <p>Choose a sample design below, upload your own, or search online.</p>
</div>

<div class="container">
  <!-- LEFT: FABRIC BOX -->
  <div class="upload-box">
    <h2>1. Fabric Details</h2>
    <div class="form-section">
      <button class="upload-btn" onclick="document.getElementById('fabricVideoInput').click()">Upload Fabric Video</button>
      <input type="file" id="fabricVideoInput" accept="video/*" hidden onchange="handlePreview(this, 'videoPreview')">
      <div class="video-preview"><video id="videoPreview" controls></video></div>
    </div>

    <div class="form-section">
      <p style="font-weight:bold; font-size:14px;">Measurements of fabric (Meters / Cm)</p><br>
      <div class="row"><label>Top fabric:</label><input type="number" id="topMeter" step="0.01" placeholder="Mtr"><input type="number" id="topCm" placeholder="Cm"></div>
      <div class="row"><label>Bottom fabric:</label><input type="number" id="bottomMeter" step="0.01" placeholder="Mtr"><input type="number" id="bottomCm" placeholder="Cm"></div>
    </div>

    <div class="form-section">
      <div class="inline-options">
        <p style="font-weight:bold; font-size:14px;">Lining Preference</p><br>
        
        <label class="inline-card"><input type="radio" name="lining" value="With Lining" checked> With Lining</label>
        <label class="inline-card"><input type="radio" name="lining" value="Without Lining"> Without Lining</label>
      </div>
     <p style="font-weight:bold; font-size:14px;">Note for Designer</p><br>
      <div class="designer-note"><textarea id="designerNote" placeholder="Notes for the designer..."></textarea></div>
    </div>
    <button class="final-submit" id="submitFabricBtn" onclick="submitFabricData()">SUBMIT FABRIC</button>
  </div>

  <!-- RIGHT: DESIGN BOX -->
  <div class="upload-box">
    <h2>2. Choose Design</h2>
    <div class="form-section">
      <button class="upload-btn" onclick="document.getElementById('designUpload').click()">Upload Inspiration Image</button>
      <input type="file" id="designUpload" accept="image/*" hidden onchange="handlePreview(this, 'designPreview')">
      <div class="image-preview"><img id="designPreview"></div>
    </div>

    
<div class="form-section">
 
 <!-- ======================================================= -->
<!-- START OF SAMPLE SECTION (Copy from here) -->
<!-- ======================================================= -->

<style>
  /* 1. CONTAINER & GRID STYLES */
  .sample-section-wrapper {
      background: #fff;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-bottom: 20px;
  }

  /* The Grid List */
  #sample-images-container {
      display: grid !important;
      grid-template-columns: repeat(3, 1fr) !important; /* Forces 3 Columns */
      gap: 10px;
      padding: 5px;
      /* Height for exactly 1 row */
      max-height: 350px; 
      overflow: hidden;
      transition: all 0.3s ease;
  }

  /* Expanded State (When "See More" is clicked) */
  #sample-images-container.expanded {
      max-height: 550px;
      overflow-y: auto;
  }

  /* 2. CARD & IMAGE STYLES */
  .design-card {
      background: white;
      border-radius: 6px;
      text-align: center;
  }
  
  .design-card img {
      width: 100% !important;
      height: 300px !important; /* Fixed Portrait Height */
      object-fit: cover !important;
      object-position: top center;
      border: 1px solid #ccc;
      border-radius: 6px;
      cursor: pointer;
      display: block;
  }

  /* Selected Green Border */
  .design-card img.selected {
      border: 5px solid #28a745 !important;
      box-sizing: border-box;
  }

  .design-card p {
      font-size: 12px;
      margin: 5px 0 0 0;
      color: #333;
  }

  /* 3. BUTTONS */
  #see-more-btn {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      background: #f8f9fa;
      border: 1px solid #ddd;
      cursor: pointer;
      font-weight: bold;
      color: #333;
      text-align: center;
      display: block;
      border-radius: 4px;
  }
  #see-more-btn:hover { background: #e2e6ea; }

  /* 4. PREVIEW OVERLAY (Hidden initially) */
  #preview-overlay {
      display: none; /* Hidden by default */
      background-color: #fffbe6; /* Light yellow background */
      border: 2px solid #8b4513;
      padding: 15px;
      text-align: center;
      border-radius: 8px;
      margin-top: 10px;
  }

  #preview-image-large {
      height: 280px; /* Kept reasonable size */
      width: auto;
      max-width: 100%;
      border-radius: 6px;
      border: 1px solid #ddd;
      margin: 10px 0;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }

  .back-btn {
      background: #333;
      color: #fff;
      padding: 6px 15px;
      border-radius: 4px;
      cursor: pointer;
      display: inline-block;
      margin-bottom: 5px;
      font-size: 13px;
  }
</style>

<!-- HTML LAYOUT -->
<div class="sample-section-wrapper">
    <h3 style="margin-top:0;">Or Choose a Sample</h3>
    
    <!-- 1. GRID LIST -->
    <div id="sample-images-container">
        <!-- Javascript loads images here -->
    </div>

    <!-- 2. PREVIEW BOX -->
    <div id="preview-overlay">
        <div class="back-btn" onclick="closePreview()">⬅ Back to Designs</div>
        <h4 id="preview-designer-name" style="margin:5px 0;"></h4>
        <img id="preview-image-large" src="" alt="Selected Design">
        <p style="color:green; font-weight:bold; margin-top:5px;">✓ Design Selected</p>
        <p style="font-size:12px; color:#666;">(Scroll down and click Submit Design)</p>
    </div>
</div>

<!-- JAVASCRIPT -->
<script>
  // A. Back Button Logic
  function closePreview() {
      // Hide Preview
      document.getElementById('preview-overlay').style.display = 'none';
      
      // Show Grid
      document.getElementById('sample-images-container').style.display = 'grid'; // Force Grid back
      
      // Show "See More" button again (if it exists)
      const btn = document.getElementById('see-more-btn');
      if (btn) btn.style.display = 'block';
  }

  // B. Load Images Logic
  async function loadSampleImages() {
      const urlParams = new URLSearchParams(window.location.search);
      const serviceType = urlParams.get('service');
      
      if (!serviceType) return;

      // 1. Remove ANY existing "See More" buttons to prevent duplicates
      const existingBtns = document.querySelectorAll('#see-more-btn');
      existingBtns.forEach(btn => btn.remove());

      // 2. Fetch Data
      // (Using 'm_db' which you already defined in your main script)
      const { data, error } = await m_db
          .from('design_samples')
          .select('*')
          .eq('category', serviceType);

      if (error) { console.error("Supabase Error:", error); return; }

      const container = document.getElementById('sample-images-container');
      if (!container) return;

      container.innerHTML = ''; // Clear container

      if (data.length === 0) {
          container.innerHTML = `<p style="padding:10px;">No designs found for ${serviceType}.</p>`;
          return;
      }

      // 3. Create Images
      data.forEach(design => {
          const card = document.createElement('div');
          card.className = 'design-card';

         
          const img = document.createElement('img');
          // 1. CORRECT IMAGE SOURCE
          img.src = design.image_url; 
          
          // 2. STORE DESIGNER NAME (Hidden)
          img.setAttribute('data-designer', design.designer_name); 
        // <--- Just keep this

          
// --------------------
          // CLICK LOGIC: Hide Grid -> Show Preview
          img.onclick = function() {
              // Highlight this image (so Submit button can find it)
              container.querySelectorAll('img').forEach(el => el.classList.remove('selected'));
              img.classList.add('selected');

              // Hide Grid
              container.style.setProperty('display', 'none', 'important');
              
              // Hide See More Button
              const btn = document.getElementById('see-more-btn');
              if (btn) btn.style.display = 'none';

              // Show Preview
              const overlay = document.getElementById('preview-overlay');
              document.getElementById('preview-image-large').src = design.image_url;
              if(document.getElementById('preview-designer-name')) {
                  document.getElementById('preview-designer-name').innerText = design.designer_name;
              }
              overlay.style.display = 'block';
          };
              

          const name = document.createElement('p');
          name.innerText = design.designer_name;

          card.appendChild(img);
          card.appendChild(name);
          container.appendChild(card);
      });

      // 4. Add "See More" Button (Only if > 3 images)
      if (data.length > 3) {
          const seeMoreBtn = document.createElement('div'); // Using Div as button wrapper
          seeMoreBtn.id = 'see-more-btn';
          seeMoreBtn.innerText = `See All ${data.length} Designs ▼`;
          
          seeMoreBtn.onclick = function() {
              container.classList.add('expanded'); // Make taller
              seeMoreBtn.style.display = 'none';   // Hide itself
          };

          // Insert AFTER the grid container
          container.parentNode.insertBefore(seeMoreBtn, container.nextSibling);
      }
  }

  // C. Run immediately
  // We use a small delay to ensure Supabase (m_db) is ready
  
</script>

<!-- ======================================================= -->
<!-- END OF SAMPLE SECTION -->
<!-- ======================================================= -->
    
    <button class="final-submit" id="submitDesignBtn" onclick="submitDesignData()">SUBMIT DESIGN</button>
  </div>
</div>
</div>
<!-- GOOGLE SEARCH SECTION -->
<div class="google-card">
  <h2>3. Search Design Online</h2>
  <button class="google-btn" onclick="window.open('https://www.google.com/search?tbm=isch&q=latest+dress+designs', '_blank')"><i class="fa-solid fa-magnifying-glass"></i> Search on Google Images</button>
  <p style="margin-top:10px; font-size:13px;">Right-click image -> Copy image address -> Paste below</p>
  <input type="text" id="googleUrl" placeholder="Paste image link here...">
  <br>
  <button class="google-btn" style="background:#99582a" onclick="previewGoogleImage()">Preview Image</button>
  <img id="urlPreview">
  <br>
  <button class="final-submit" style="width:auto; padding: 15px 50px;" id="submitGoogleBtn" onclick="submitGoogleDesign()">USE THIS IMAGE</button>
</div>
<div class="nav-buttons">
  <a href="javascript:void(0)" id="measurementBtn" class="nav-btn">Add your measurements</a>
  <a href="/service pages/pickup2.html" class="nav-btn">Send your measurement cloth</a>
</div>
<footer><p>© 2025 MODASOU - LUXURY, CUSTOMIZED</p></footer>


<script>
  // 1. INITIALIZATION
  const m_db = window.supabase.createClient(
    "https://gztneesmxwfhdmhqikel.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd6dG5lZXNteHdmaGRtaHFpa2VsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxNjAzNDAsImV4cCI6MjA4MjczNjM0MH0.iWDtkljuQLZFQeLvBrJHVyXNfpu4bJOvvVab3G0eOsA"
  );

  let sessionId = localStorage.getItem("modasou_session_id") || "sess_" + Math.random().toString(36).substr(2, 9);
  localStorage.setItem("modasou_session_id", sessionId);

  // 2. METER/CM SYNC
  function setupSync(mId, cId) {
    const m = document.getElementById(mId), c = document.getElementById(cId);
    m.oninput = () => c.value = m.value ? Math.round(m.value * 100) : '';
    c.oninput = () => m.value = c.value ? (c.value / 100).toFixed(2) : '';
  }

  document.addEventListener("DOMContentLoaded", () => {
    setupSync('topMeter', 'topCm');
    setupSync('bottomMeter', 'bottomCm');
    loadSampleImages(); // <--- ADDED: Load images when page is ready
  });

  // 3. PREVIEWS & SELECTION
  function handlePreview(input, pId) {
    const file = input.files[0], el = document.getElementById(pId);
    if (file) {
      el.src = URL.createObjectURL(file);
      el.style.display = 'block';
      if(el.tagName === 'VIDEO') el.load();
    }
  }

  function previewGoogleImage() {
    const url = document.getElementById('googleUrl').value.trim();
    const img = document.getElementById('urlPreview');
    if (url) { img.src = url; img.style.display = 'block'; }
  }









  




  // ------------------------------------------------

  // 4. BACKEND FUNCTIONS (KEPT EXACTLY AS IS)
  
  async function submitFabricData() {
    localStorage.setItem("active_service", "service2");
    const btn = document.getElementById('submitFabricBtn'), file = document.getElementById('fabricVideoInput').files[0];
    if (!file) return alert("Please upload a fabric video");
    btn.innerText = "Uploading..."; btn.disabled = true;

    try {
      const path = `fabric_${sessionId}_${Date.now()}.mp4`;
      await m_db.storage.from('fabrics').upload(path, file);
      const { data } = m_db.storage.from('fabrics').getPublicUrl(path);

      await m_db.from('service_2').upsert([{
        session_id: sessionId,
        fabric_video_url: data.publicUrl,
        top_mtr: document.getElementById('topMeter').value || null,
        top_cm: document.getElementById('topCm').value || null,
        bottom_mtr: document.getElementById('bottomMeter').value || null,
        bottom_cm: document.getElementById('bottomCm').value || null,
        lining_preference: document.querySelector('input[name="lining"]:checked').value,
        designer_note: document.getElementById('designerNote').value || null,
        created_at: new Date()
      }], { onConflict: 'session_id' });

      alert("Success! Fabric data saved for Session: " + sessionId);
      btn.innerText = "SUBMITTED ✓";
    } catch (e) { alert(e.message); btn.disabled = false; btn.innerText = "SUBMIT FABRIC"; }
  }






async function submitDesignData() {
  localStorage.setItem("active_service", "service2");
  const btn = document.getElementById('submitDesignBtn');
  const file = document.getElementById('designUpload').files[0];
  const sampleImg = document.querySelector('#sample-images-container img.selected');
  
  if (!file && !sampleImg) return alert("Please upload an image or select a sample");
  
  btn.innerText = "Saving..."; 
  btn.disabled = true;

  try {
    let finalUrl = "";
    let designerName = "Custom Upload";
    
    // Handle File Upload
    if (file) {
      const path = `design_${sessionId}_${Date.now()}.jpg`;
      await m_db.storage.from('designs').upload(path, file);
      finalUrl = m_db.storage.from('designs').getPublicUrl(path).data.publicUrl;
    } 
    // Handle Sample Design
    else if (sampleImg) {
      finalUrl = sampleImg.src;
      designerName = sampleImg.getAttribute('data-designer');
    }

    // ✅ FIX: UPDATE ONLY design fields, preserve fabric
    await m_db.from('service_2')
      .update({
        design_image_url: finalUrl,
        designer_name: designerName,
        created_at: new Date()
      })
      .eq('session_id', sessionId);

    alert("Design saved! ✅");
    btn.innerText = "SUBMITTED ✓";
  } catch (e) { 
    alert(e.message); 
    btn.disabled = false; 
    btn.innerText = "SUBMIT DESIGN";
  }
}


async function submitGoogleDesign() {
  localStorage.setItem("active_service", "service2");
  let url = document.getElementById('googleUrl').value.trim();

  if (!url) return alert("Please paste an image link first");

  // ✅ CLEAN GOOGLE IMAGE URL
  if (url.includes("google.com/imgres")) {
    const params = new URLSearchParams(url.split("?")[1]);
    url = params.get("imgrefurl") || url;
  }

  const btn = document.getElementById('submitGoogleBtn');
  btn.innerText = "Saving Link...";

  try {
    const { error, data } = await m_db.from('service_2')
      .update({
        google_image_url: url,
        created_at: new Date()
      })
      .eq('session_id', sessionId)
      .select();

    if (error) throw error;

    console.log("✅ GOOGLE SAVED:", data);
    alert("Online design saved! ✅");
    btn.innerText = "SAVED ✓";

  } catch (e) {
    console.error("GOOGLE ERROR:", e);
    alert(e.message);
    btn.innerText = "USE THIS IMAGE";
  }
}




  


  // NAVIGATION
  document.getElementById("measurementBtn").onclick = () => {
    const s = new URLSearchParams(window.location.search).get("service");
    if(!s) return alert("Select service first");
    const routes = { blouse: "measurement-blouse.html", dress: "measurement-dress.html", top: "measurement-Tops.html", kurta: "measurement-kurta.html", skirt: "measurement-skirt.html", lehenga: "measurement-lehenga.html", pant: "measurement-pants.html" };
    window.location.href = routes[s] || alert("Route not found");
  };
</script></body></html>